(function(d){function f(k){var j=d.data(k,"tagbox");var i=j.options;d(k).addClass("tagbox-f").combobox(d.extend({},i,{cls:"tagbox",reversed:true,onChange:function(m,l){h();d(this).combobox("hidePanel");i.onChange.call(k,m,l)},onResizing:function(n,l){var p=d(this).combobox("textbox");var m=d(this).data("textbox").textbox;var o=m.outerWidth();m.css({height:"",paddingLeft:p.css("marginLeft"),paddingRight:p.css("marginRight")});p.css("margin",0);m._outerWidth(o);g(k);e(this);i.onResizing.call(k,n,l)},onLoadSuccess:function(l){h();i.onLoadSuccess.call(k,l)}}));h();g(k);function h(){d(k).next().find(".tagbox-label").remove();var l=d(k).tagbox("textbox");var m=[];d.map(d(k).tagbox("getValues"),function(n,t){var r=i.finder.getRow(k,n);var s=i.tagFormatter.call(k,n,r);var p={};var o=i.tagStyler.call(k,n,r)||"";if(typeof o=="string"){p={s:o}}else{p={c:o["class"]||"",s:o.style||""}}var q=d('<span class="tagbox-label"></span>').insertBefore(l).html(s);q.attr("tagbox-index",t);q.attr("style",p.s).addClass(p.c);d('<a href="javascript:;" class="tagbox-remove"></a>').appendTo(q)});e(k);d(k).combobox("setText","")}}function e(o,n){var l=d(o).next();var k=n?d(n):l.find(".tagbox-label");if(k.length){var j=d(o).tagbox("textbox");var i=d(k[0]);var h=i.outerHeight(true)-i.outerHeight();var p=j.outerHeight()-h*2;k.css({height:p+"px",lineHeight:p+"px"});var m=l.find(".textbox-addon").css("height","100%");m.find(".textbox-icon").css("height","100%");l.find(".textbox-button").linkbutton("resize",{height:"100%"})}}function b(i){var h=d(i).next();h.unbind(".tagbox").bind("click.tagbox",function(m){var k=d(i).tagbox("options");if(k.disabled||k.readonly){return}if(d(m.target).hasClass("tagbox-remove")){var l=parseInt(d(m.target).parent().attr("tagbox-index"));var j=d(i).tagbox("getValues");if(k.onBeforeRemoveTag.call(i,j[l])==false){return}k.onRemoveTag.call(i,j[l]);j.splice(l,1);d(i).tagbox("setValues",j)}else{var n=d(m.target).closest(".tagbox-label");if(n.length){var l=parseInt(n.attr("tagbox-index"));var j=d(i).tagbox("getValues");k.onClickTag.call(i,j[l])}}d(this).find(".textbox-text").focus()}).bind("keyup.tagbox",function(j){g(i)}).bind("mouseover.tagbox",function(j){if(d(j.target).closest(".textbox-button,.textbox-addon,.tagbox-label").length){d(this).triggerHandler("mouseleave")}else{d(this).find(".textbox-text").triggerHandler("mouseenter")}}).bind("mouseleave.tagbox",function(j){d(this).find(".textbox-text").triggerHandler("mouseleave")})}function g(o){var n=d(o).tagbox("options");var m=d(o).tagbox("textbox");var l=d(o).next();var i=d("<span></span>").appendTo("body");i.attr("style",m.attr("style"));i.css({position:"absolute",top:-9999,left:-9999,width:"auto",fontFamily:m.css("fontFamily"),fontSize:m.css("fontSize"),fontWeight:m.css("fontWeight"),whiteSpace:"nowrap"});var k=j(m.val());var h=j(n.prompt||"");i.remove();var p=Math.min(Math.max(k,h)+20,l.width());m._outerWidth(p);l.find(".textbox-button").linkbutton("resize",{height:"100%"});function j(r){var q=r.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");i.html(q);return i.outerWidth()}}function c(n){var o=d(n);var l=o.tagbox("options");if(l.limitToList){var k=o.tagbox("panel");var j=k.children("div.combobox-item-hover");if(j.length){j.removeClass("combobox-item-hover");var p=l.finder.getRow(n,j);var i=p[l.valueField];d(n).tagbox(j.hasClass("combobox-item-selected")?"unselect":"select",i)}d(n).tagbox("hidePanel")}else{var m=d.trim(d(n).tagbox("getText"));if(m!==""){var h=d(n).tagbox("getValues");h.push(m);d(n).tagbox("setValues",h)}}}function a(i,h){d(i).combobox("setText","");g(i);d(i).combobox("setValues",h);d(i).combobox("setText","");d(i).tagbox("validate")}d.fn.tagbox=function(j,i){if(typeof j=="string"){var h=d.fn.tagbox.methods[j];if(h){return h(this,i)}else{return this.combobox(j,i)}}j=j||{};return this.each(function(){var k=d.data(this,"tagbox");if(k){d.extend(k.options,j)}else{d.data(this,"tagbox",{options:d.extend({},d.fn.tagbox.defaults,d.fn.tagbox.parseOptions(this),j)})}f(this);b(this)})};d.fn.tagbox.methods={options:function(i){var h=i.combobox("options");return d.extend(d.data(i[0],"tagbox").options,{width:h.width,height:h.height,originalValue:h.originalValue,disabled:h.disabled,readonly:h.readonly})},setValues:function(i,h){return i.each(function(){a(this,h)})},reset:function(h){return h.each(function(){d(this).combobox("reset").combobox("setText","")})}};d.fn.tagbox.parseOptions=function(h){return d.extend({},d.fn.combobox.parseOptions(h),d.parser.parseOptions(h,[]))};d.fn.tagbox.defaults=d.extend({},d.fn.combobox.defaults,{hasDownArrow:false,multiple:true,reversed:true,selectOnNavigation:false,tipOptions:d.extend({},d.fn.textbox.defaults.tipOptions,{showDelay:200}),val:function(h){var i=d(h).parent().prev().tagbox("getValues");if(d(h).is(":focus")){i.push(d(h).val())}return i.join(",")},inputEvents:d.extend({},d.fn.combo.defaults.inputEvents,{blur:function(j){var i=j.data.target;var h=d(i).tagbox("options");if(h.limitToList){c(i)}}}),keyHandler:d.extend({},d.fn.combobox.defaults.keyHandler,{enter:function(h){c(this)},query:function(i,j){var h=d(this).tagbox("options");if(h.limitToList){d.fn.combobox.defaults.keyHandler.query.call(this,i,j)}else{d(this).combobox("hidePanel")}}}),tagFormatter:function(i,j){var h=d(this).tagbox("options");return j?j[h.textField]:i},tagStyler:function(h,i){return""},onClickTag:function(h){},onBeforeRemoveTag:function(h){},onRemoveTag:function(h){}})})(jQuery);