(function(j){j(function(){j(document).unbind(".combo").bind("mousedown.combo mousewheel.combo",function(r){var q=j(r.target).closest("span.combo,div.combo-p,div.menu");if(q.length){o(q);return}j("body>div.combo-p>div.combo-panel:visible").panel("close")})});function n(u){var t=j.data(u,"combo");var s=t.options;if(!t.panel){t.panel=j('<div class="combo-panel"></div>').appendTo("body");t.panel.panel({minWidth:s.panelMinWidth,maxWidth:s.panelMaxWidth,minHeight:s.panelMinHeight,maxHeight:s.panelMaxHeight,doSize:false,closed:true,cls:"combo-p",style:{position:"absolute",zIndex:10},onOpen:function(){var w=j(this).panel("options").comboTarget;var v=j.data(w,"combo");if(v){v.options.onShowPanel.call(w)}},onBeforeClose:function(){o(j(this).parent())},onClose:function(){var w=j(this).panel("options").comboTarget;var v=j(w).data("combo");if(v){v.options.onHidePanel.call(w)}}})}var r=j.extend(true,[],s.icons);if(s.hasDownArrow){r.push({iconCls:"combo-arrow",handler:function(v){k(v.data.target)}})}j(u).addClass("combo-f").textbox(j.extend({},s,{icons:r,onChange:function(){}}));j(u).attr("comboName",j(u).attr("textboxName"));t.combo=j(u).next();t.combo.addClass("combo");t.panel.unbind(".combo");for(var q in s.panelEvents){t.panel.bind(q+".combo",{target:u},s.panelEvents[q])}}function l(r){var q=j.data(r,"combo");var t=q.options;var s=q.panel;if(s.is(":visible")){s.panel("close")}if(!t.cloned){s.panel("destroy")}j(r).textbox("destroy")}function k(t){var s=j.data(t,"combo").panel;if(s.is(":visible")){var q=s.combo("combo");g(q);if(q!=t){j(t).combo("showPanel")}}else{var r=j(t).closest("div.combo-p").children(".combo-panel");j("div.combo-panel:visible").not(s).not(r).panel("close");j(t).combo("showPanel")}j(t).combo("textbox").focus()}function o(q){j(q).find(".combo-f").each(function(){var r=j(this).combo("panel");if(r.is(":visible")){r.panel("close")}})}function e(u){var s=u.data.target;var r=j.data(s,"combo");var q=r.options;if(!q.editable){k(s)}else{var t=j(s).closest("div.combo-p").children(".combo-panel");j("div.combo-panel:visible").not(t).each(function(){var v=j(this).combo("combo");if(v!=s){g(v)}})}}function h(v){var s=v.data.target;var u=j(s);var r=u.data("combo");var q=u.combo("options");r.panel.panel("options").comboTarget=s;switch(v.keyCode){case 38:q.keyHandler.up.call(s,v);break;case 40:q.keyHandler.down.call(s,v);break;case 37:q.keyHandler.left.call(s,v);break;case 39:q.keyHandler.right.call(s,v);break;case 13:v.preventDefault();q.keyHandler.enter.call(s,v);return false;case 9:case 27:g(s);break;default:if(q.editable){if(r.timer){clearTimeout(r.timer)}r.timer=setTimeout(function(){var t=u.combo("getText");if(r.previousText!=t){r.previousText=t;u.combo("showPanel");q.keyHandler.query.call(s,t,v);u.combo("validate")}},q.delay)}}}function c(s){var r=s.data.target;var q=j(r).data("combo");if(q.timer){clearTimeout(q.timer)}}function a(x){var w=j.data(x,"combo");var v=w.combo;var t=w.panel;var s=j(x).combo("options");var r=t.panel("options");r.comboTarget=x;if(r.closed){t.panel("panel").show().css({zIndex:(j.fn.menu?j.fn.menu.defaults.zIndex++:(j.fn.window?j.fn.window.defaults.zIndex++:99)),left:-999999});t.panel("resize",{width:(s.panelWidth?s.panelWidth:v._outerWidth()),height:s.panelHeight});t.panel("panel").hide();t.panel("open")}(function(){if(r.comboTarget==x&&t.is(":visible")){t.panel("move",{left:q(),top:u()});setTimeout(arguments.callee,200)}})();function q(){var y=v.offset().left;if(s.panelAlign=="right"){y+=v._outerWidth()-t._outerWidth()}if(y+t._outerWidth()>j(window)._outerWidth()+j(document).scrollLeft()){y=j(window)._outerWidth()+j(document).scrollLeft()-t._outerWidth()}if(y<0){y=0}return y}function u(){if(s.panelValign=="top"){var y=v.offset().top-t._outerHeight()}else{if(s.panelValign=="bottom"){var y=v.offset().top+v._outerHeight()}else{var y=v.offset().top+v._outerHeight();if(y+t._outerHeight()>j(window)._outerHeight()+j(document).scrollTop()){y=v.offset().top-t._outerHeight()}if(y<j(document).scrollTop()){y=v.offset().top+v._outerHeight()}}}return y}}function g(r){var q=j.data(r,"combo").panel;q.panel("close")}function p(s,t){var r=j.data(s,"combo");var q=j(s).textbox("getText");if(q!=t){j(s).textbox("setText",t)}r.previousText=t}function m(u){var t=j.data(u,"combo");var s=t.options;var r=j(u).next();var q=[];r.find(".textbox-value").each(function(){q.push(j(this).val())});if(s.multivalue){return q}else{return q.length?q[0].split(s.separator):q}}function i(y,x){var w=j.data(y,"combo");var v=w.combo;var u=j(y).combo("options");if(!j.isArray(x)){x=x.split(u.separator)}var t=m(y);v.find(".textbox-value").remove();if(x.length){if(u.multivalue){for(var r=0;r<x.length;r++){s(x[r])}}else{s(x.join(u.separator))}}function s(B){var A=j(y).attr("textboxName")||"";var z=j('<input type="hidden" class="textbox-value">').appendTo(v);z.attr("name",A);if(u.disabled){z.attr("disabled","disabled")}z.val(B)}var q=(function(){if(u.onChange==j.parser.emptyFn){return false}if(t.length!=x.length){return true}for(var z=0;z<x.length;z++){if(x[z]!=t[z]){return true}}return false})();if(q){j(y).val(x.join(u.separator));if(u.multiple){u.onChange.call(y,x,t)}else{u.onChange.call(y,x[0],t[0])}j(y).closest("form").trigger("_change",[y])}}function d(r){var q=m(r);return q[0]}function b(r,q){i(r,[q])}function f(s){var r=j.data(s,"combo").options;var q=r.onChange;r.onChange=j.parser.emptyFn;if(r.multiple){i(s,r.value?r.value:[])}else{b(s,r.value)}r.onChange=q}j.fn.combo=function(r,s){if(typeof r=="string"){var q=j.fn.combo.methods[r];if(q){return q(this,s)}else{return this.textbox(r,s)}}r=r||{};return this.each(function(){var t=j.data(this,"combo");if(t){j.extend(t.options,r);if(r.value!=undefined){t.options.originalValue=r.value}}else{t=j.data(this,"combo",{options:j.extend({},j.fn.combo.defaults,j.fn.combo.parseOptions(this),r),previousText:""});if(t.options.multiple&&t.options.value==""){t.options.originalValue=[]}else{t.options.originalValue=t.options.value}}n(this);f(this)})};j.fn.combo.methods={options:function(r){var q=r.textbox("options");return j.extend(j.data(r[0],"combo").options,{width:q.width,height:q.height,disabled:q.disabled,readonly:q.readonly})},cloneFrom:function(r,q){return r.each(function(){j(this).textbox("cloneFrom",q);j.data(this,"combo",{options:j.extend(true,{cloned:true},j(q).combo("options")),combo:j(this).next(),panel:j(q).combo("panel")});j(this).addClass("combo-f").attr("comboName",j(this).attr("textboxName"))})},combo:function(q){return q.closest(".combo-panel").panel("options").comboTarget},panel:function(q){return j.data(q[0],"combo").panel},destroy:function(q){return q.each(function(){l(this)})},showPanel:function(q){return q.each(function(){a(this)})},hidePanel:function(q){return q.each(function(){g(this)})},clear:function(q){return q.each(function(){j(this).textbox("setText","");var r=j.data(this,"combo").options;if(r.multiple){j(this).combo("setValues",[])}else{j(this).combo("setValue","")}})},reset:function(q){return q.each(function(){var r=j.data(this,"combo").options;if(r.multiple){j(this).combo("setValues",r.originalValue)}else{j(this).combo("setValue",r.originalValue)}})},setText:function(r,q){return r.each(function(){p(this,q)})},getValues:function(q){return m(q[0])},setValues:function(r,q){return r.each(function(){i(this,q)})},getValue:function(q){return d(q[0])},setValue:function(r,q){return r.each(function(){b(this,q)})}};j.fn.combo.parseOptions=function(q){var r=j(q);return j.extend({},j.fn.textbox.parseOptions(q),j.parser.parseOptions(q,["separator","panelAlign",{panelWidth:"number",hasDownArrow:"boolean",delay:"number",reversed:"boolean",multivalue:"boolean",selectOnNavigation:"boolean"},{panelMinWidth:"number",panelMaxWidth:"number",panelMinHeight:"number",panelMaxHeight:"number"}]),{panelHeight:(r.attr("panelHeight")=="auto"?"auto":parseInt(r.attr("panelHeight"))||undefined),multiple:(r.attr("multiple")?true:undefined)})};j.fn.combo.defaults=j.extend({},j.fn.textbox.defaults,{inputEvents:{click:e,keydown:h,paste:h,drop:h,blur:c},panelEvents:{mousedown:function(q){q.preventDefault();q.stopPropagation()}},panelWidth:null,panelHeight:300,panelMinWidth:null,panelMaxWidth:null,panelMinHeight:null,panelMaxHeight:null,panelAlign:"left",panelValign:"auto",reversed:false,multiple:false,multivalue:true,selectOnNavigation:true,separator:",",hasDownArrow:true,delay:200,keyHandler:{up:function(q){},down:function(q){},left:function(q){},right:function(q){},enter:function(q){},query:function(r,s){}},onShowPanel:function(){},onHidePanel:function(){},onChange:function(r,q){}})})(jQuery);