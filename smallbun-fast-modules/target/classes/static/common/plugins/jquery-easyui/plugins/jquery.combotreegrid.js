(function(c){function d(j){var i=c.data(j,"combotreegrid");var h=i.options;c(j).addClass("combotreegrid-f").combo(c.extend({},h,{onShowPanel:function(){var q=c(this).combotreegrid("panel");var n=q.outerHeight()-q.height();var m=q._size("minHeight");var l=q._size("maxHeight");var o=c(this).combotreegrid("grid");o.treegrid("resize",{width:"100%",height:(isNaN(parseInt(h.panelHeight))?"auto":"100%"),minHeight:(m?m-n:""),maxHeight:(l?l-n:"")});var k=o.treegrid("getSelected");if(k){o.treegrid("scrollTo",k[h.idField])}h.onShowPanel.call(this)}}));if(!i.grid){var g=c(j).combo("panel");i.grid=c("<table></table>").appendTo(g)}i.grid.treegrid(c.extend({},h,{border:false,checkbox:h.multiple,onLoadSuccess:function(m,l){var k=c(j).combotreegrid("getValues");if(h.multiple){c.map(c(this).treegrid("getCheckedNodes"),function(n){c.easyui.addArrayItem(k,n[h.idField])})}a(j,k);h.onLoadSuccess.call(this,m,l);i.remainText=false},onClickRow:function(k){if(h.multiple){c(this).treegrid(k.checked?"uncheckNode":"checkNode",k[h.idField]);c(this).treegrid("unselect",k[h.idField])}else{c(j).combo("hidePanel")}f(j);h.onClickRow.call(this,k)},onCheckNode:function(l,k){f(j);h.onCheckNode.call(this,l,k)}}))}function f(k){var j=c.data(k,"combotreegrid");var h=j.options;var g=j.grid;var i=[];if(h.multiple){i=c.map(g.treegrid("getCheckedNodes"),function(m){return m[h.idField]})}else{var l=g.treegrid("getSelected");if(l){i.push(l[h.idField])}}i=i.concat(h.unselectedValues);a(k,i)}function a(k,j){var g=c.data(k,"combotreegrid");var n=g.options;var m=g.grid;if(!c.isArray(j)){j=j.split(n.separator)}if(!n.multiple){j=j.length?[j[0]]:[""]}var o=c.map(j,function(r){return String(r)});o=c.grep(o,function(s,r){return r===c.inArray(s,o)});var l=m.treegrid("getSelected");if(l){m.treegrid("unselect",l[n.idField])}c.map(m.treegrid("getCheckedNodes"),function(r){if(c.inArray(String(r[n.idField]),o)==-1){m.treegrid("uncheckNode",r[n.idField])}});var q=[];n.unselectedValues=[];c.map(o,function(r){var s=m.treegrid("find",r);if(s){if(n.multiple){m.treegrid("checkNode",r)}else{m.treegrid("select",r)}q.push(h(s))}else{q.push(i(r,n.mappingRows)||r);n.unselectedValues.push(r)}});if(n.multiple){c.map(m.treegrid("getCheckedNodes"),function(r){var s=String(r[n.idField]);if(c.inArray(s,o)==-1){o.push(s);q.push(h(r))}})}if(!g.remainText){var p=q.join(n.separator);if(c(k).combo("getText")!=p){c(k).combo("setText",p)}}c(k).combo("setValues",o);function i(r,s){var t=c.easyui.getArrayItem(s,n.idField,r);return t?h(t):undefined}function h(r){return r[n.textField||""]||r[n.treeField]}}function e(o,g){var n=c.data(o,"combotreegrid");var m=n.options;var l=n.grid;n.remainText=true;var i=m.multiple?g.split(m.separator):[g];i=c.grep(i,function(p){return c.trim(p)!=""});l.treegrid("clearSelections").treegrid("clearChecked").treegrid("highlightRow",-1);if(m.mode=="remote"){j(i);l.treegrid("load",c.extend({},m.queryParams,{q:g}))}else{if(g){var h=l.treegrid("getData");var k=[];c.map(i,function(r){r=c.trim(r);if(r){var p=undefined;c.easyui.forEach(h,true,function(q){if(r.toLowerCase()==String(q[m.treeField]).toLowerCase()){p=q[m.idField];return false}else{if(m.filter.call(o,r,q)){l.treegrid("expandTo",q[m.idField]);l.treegrid("highlightRow",q[m.idField]);return false}}});if(p==undefined){c.easyui.forEach(m.mappingRows,false,function(q){if(r.toLowerCase()==String(q[m.treeField])){p=q[m.idField];return false}})}if(p!=undefined){k.push(p)}else{k.push(r)}}});j(k);n.remainText=false}}function j(p){if(!m.reversed){c(o).combotreegrid("setValues",p)}}}function b(j){var i=c.data(j,"combotreegrid");var h=i.options;var g=i.grid;var l=h.finder.getTr(g[0],null,"highlight");i.remainText=false;if(l.length){var n=l.attr("node-id");if(h.multiple){if(l.hasClass("datagrid-row-selected")){g.treegrid("uncheckNode",n)}else{g.treegrid("checkNode",n)}}else{g.treegrid("selectRow",n)}}var k=[];if(h.multiple){c.map(g.treegrid("getCheckedNodes"),function(o){k.push(o[h.idField])})}else{var m=g.treegrid("getSelected");if(m){k.push(m[h.idField])}}c.map(h.unselectedValues,function(o){if(c.easyui.indexOfArray(h.mappingRows,h.idField,o)>=0){c.easyui.addArrayItem(k,o)}});c(j).combotreegrid("setValues",k);if(!h.multiple){c(j).combotreegrid("hidePanel")}}c.fn.combotreegrid=function(h,i){if(typeof h=="string"){var g=c.fn.combotreegrid.methods[h];if(g){return g(this,i)}else{return this.combo(h,i)}}h=h||{};return this.each(function(){var j=c.data(this,"combotreegrid");if(j){c.extend(j.options,h)}else{j=c.data(this,"combotreegrid",{options:c.extend({},c.fn.combotreegrid.defaults,c.fn.combotreegrid.parseOptions(this),h)})}d(this)})};c.fn.combotreegrid.methods={options:function(h){var g=h.combo("options");return c.extend(c.data(h[0],"combotreegrid").options,{width:g.width,height:g.height,originalValue:g.originalValue,disabled:g.disabled,readonly:g.readonly})},grid:function(g){return c.data(g[0],"combotreegrid").grid},setValues:function(h,g){return h.each(function(){var i=c(this).combotreegrid("options");if(c.isArray(g)){g=c.map(g,function(j){if(j&&typeof j=="object"){c.easyui.addArrayItem(i.mappingRows,i.idField,j);return j[i.idField]}else{return j}})}a(this,g)})},setValue:function(h,g){return h.each(function(){c(this).combotreegrid("setValues",c.isArray(g)?g:[g])})},clear:function(g){return g.each(function(){c(this).combotreegrid("setValues",[])})},reset:function(g){return g.each(function(){var h=c(this).combotreegrid("options");if(h.multiple){c(this).combotreegrid("setValues",h.originalValue)}else{c(this).combotreegrid("setValue",h.originalValue)}})}};c.fn.combotreegrid.parseOptions=function(h){var g=c(h);return c.extend({},c.fn.combo.parseOptions(h),c.fn.treegrid.parseOptions(h),c.parser.parseOptions(h,["mode",{limitToGrid:"boolean"}]))};c.fn.combotreegrid.defaults=c.extend({},c.fn.combo.defaults,c.fn.treegrid.defaults,{editable:false,singleSelect:true,limitToGrid:false,unselectedValues:[],mappingRows:[],mode:"local",textField:null,keyHandler:{up:function(g){},down:function(g){},left:function(g){},right:function(g){},enter:function(g){b(this)},query:function(g,h){e(this,g)}},inputEvents:c.extend({},c.fn.combo.defaults.inputEvents,{blur:function(h){c.fn.combo.defaults.inputEvents.blur(h);var i=h.data.target;var g=c(i).combotreegrid("options");if(g.limitToGrid){b(i)}}}),filter:function(h,i){var g=c(this).combotreegrid("options");return(i[g.treeField]||"").toLowerCase().indexOf(h.toLowerCase())>=0}})})(jQuery);